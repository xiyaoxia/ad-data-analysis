# Wesing å¹¿å‘Šæ•°æ®ç‹¬ç«‹æ¸…æ´—è„šæœ¬ï¼ˆæœ€ç»ˆç‰ˆï¼šåŒ¹é…æ–°ecpmå­—æ®µ+æ—¥æœŸç½®é¡¶+çº¯å¹´æœˆæ—¥ï¼‰
import pandas as pd
import numpy as np

# ===================== é…ç½®é¡¹ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰=====================
wesing_path = "D:\ä¸‹è½½\å‘¨æŠ¥\gitDate\print\sql_wesing.csv"
save_path = "D:\ä¸‹è½½\å‘¨æŠ¥\gitDate\print\æ¸…æ´—å_Wesingå¹¿å‘Šæ•°æ®.xlsx"
source_date_col = "ç»Ÿè®¡æ—¥æœŸ"  # æºæ•°æ®åŸå§‹æ—¥æœŸåˆ—å

# ===================== 1. è¯»å–æ•°æ® =====================
print("å¼€å§‹è¯»å–WesingåŸå§‹æ•°æ®...")
try:
    df = pd.read_csv(wesing_path, encoding='utf-8', index_col=False)
except:
    df = pd.read_csv(wesing_path, encoding='gbk', index_col=False)
df = df.reset_index(drop=True)

# ===================== 2. æ—¥æœŸæ ‡å‡†åŒ–å¤„ç†ï¼ˆå’ŒJooxç»Ÿä¸€é€»è¾‘ï¼Œæ— ä¸´æ—¶åˆ—ï¼‰=====================
print("ç»Ÿä¸€æ—¥æœŸæ ¼å¼ï¼ˆä»…ä¿ç•™å¹´æœˆæ—¥ï¼Œåˆ é™¤åŸå§‹æ—¥æœŸåˆ—ï¼‰...")
# æ­¥éª¤1ï¼šåŸºäºæºæ—¥æœŸåˆ—ç”Ÿæˆæœ€ç»ˆçº¯å¹´æœˆæ—¥æ—¥æœŸåˆ—
df[source_date_col] = df[source_date_col].astype(str).str.replace(",", "").str.strip()
df["æ—¥æœŸ"] = pd.to_datetime(df[source_date_col], format="%Y%m%d", errors='coerce').dt.date
# æ­¥éª¤2ï¼šè¿‡æ»¤ç©ºæ—¥æœŸè¡Œ
df = df.dropna(subset=["æ—¥æœŸ"], how="any")
# æ­¥éª¤3ï¼šåˆ é™¤æºæ—¥æœŸåˆ—
df = df.drop(columns=[source_date_col])

# ===================== 3. æ—¥æœŸåˆ—ç½®é¡¶ =====================
df = df[["æ—¥æœŸ"] + [col for col in df.columns if col != "æ—¥æœŸ"]]

# ===================== 4. å¤„ç†ç¼ºå¤±å€¼ï¼ˆåŒ¹é…æ–°ecpmå­—æ®µï¼šå¤§ç›˜å¹¿å‘Šecpmã€æ¿€åŠ±å¹¿å‘Šecpmï¼‰=====================
print("å¤„ç†ç¼ºå¤±å€¼...")
num_cols = [
    "dau", "å¹¿å‘Šæ”¶å…¥$", "é“¶å¸æ¿€åŠ±å¹¿å‘Šæ”¶å…¥", "å¹¿å‘Šæ›å…‰æ¬¡æ•°",
    "å¤§ç›˜å¹¿å‘Šecpm", "æ¿€åŠ±å¹¿å‘Šecpm",  # æ›¿æ¢ä¸ºæ–°çš„åŒºåˆ†å­—æ®µï¼Œæ— å¤‡ç”¨
    "æ¿€åŠ±&æ’å±å¹¿å‘Šæ›å…‰", "å®é™…ROI(å«åˆ†æˆ)", "çœ‹å¹¿å‘Šäººæ•°", "inn", "rew"
]
df[num_cols] = df[num_cols].fillna(0)

# ===================== 5. å¤„ç†å¼‚å¸¸å€¼ =====================
print("å¤„ç†å¼‚å¸¸å€¼...")
df = df[(df["dau"] > 0) & (df["å¹¿å‘Šæ›å…‰æ¬¡æ•°"] >= 0)]
df = df[df["å¹¿å‘Šæ”¶å…¥$"] <= df["å¹¿å‘Šæ”¶å…¥$"].quantile(0.99)]

# ===================== 6. è®¡ç®—è¡ç”ŸæŒ‡æ ‡ï¼ˆåŸºäºæ–°ecpmå­—æ®µï¼Œæ— ä¿®æ”¹ï¼‰=====================
print("è®¡ç®—è¡ç”ŸæŒ‡æ ‡...")
df["å•æ›å…‰æ”¶ç›Š_$"] = np.where(
    df["å¹¿å‘Šæ›å…‰æ¬¡æ•°"] > 0,
    (df["å¹¿å‘Šæ”¶å…¥$"] / df["å¹¿å‘Šæ›å…‰æ¬¡æ•°"]).round(6),
    0
)
df["é“¶å¸æ¿€åŠ±æ”¶å…¥å æ¯”"] = np.where(
    df["å¹¿å‘Šæ”¶å…¥$"] > 0,
    (df["é“¶å¸æ¿€åŠ±å¹¿å‘Šæ”¶å…¥"] / df["å¹¿å‘Šæ”¶å…¥$"]).round(4),
    0
)
df["æ’å±å¹¿å‘Šæ›å…‰å æ¯”"] = np.where(
    df["æ¿€åŠ±&æ’å±å¹¿å‘Šæ›å…‰"] > 0,
    (df["inn"] / df["æ¿€åŠ±&æ’å±å¹¿å‘Šæ›å…‰"]).round(4),
    0
)
df["æ¿€åŠ±å¹¿å‘Šæ›å…‰å æ¯”"] = np.where(
    df["æ¿€åŠ±&æ’å±å¹¿å‘Šæ›å…‰"] > 0,
    (df["rew"] / df["æ¿€åŠ±&æ’å±å¹¿å‘Šæ›å…‰"]).round(4),
    0
)

# ===================== 7. ä¿å­˜ç»“æœ =====================
print("ä¿å­˜æ¸…æ´—åæ•°æ®...")
df.to_excel(save_path, index=False, engine="openpyxl")

# ===================== 8. è¾“å‡ºæ¸…æ´—æ€»ç»“ =====================
print("===== Wesing æ•°æ®æ¸…æ´—å®Œæˆï¼ =====")
print(f"ğŸ“Š æœ‰æ•ˆæ•°æ®é‡ï¼š{len(df)} è¡Œ")
min_date = df["æ—¥æœŸ"].min()
max_date = df["æ—¥æœŸ"].max()
print(f"ğŸ—“ï¸  æ—¶é—´èŒƒå›´ï¼š{min_date} è‡³ {max_date}")
print(f"ğŸ’¾ ä¿å­˜è·¯å¾„ï¼š{save_path}")
print(f"âœ… å·²å¤„ç†ï¼šæ—¥æœŸåˆ—ç½®é¡¶+åˆ é™¤åŸå§‹æ—¥æœŸåˆ—+çº¯å¹´æœˆæ—¥æ— æ—¶åˆ†ç§’+åŒ¹é…æ–°ecpmå­—æ®µï¼ˆå¤§ç›˜/æ¿€åŠ±ï¼‰")